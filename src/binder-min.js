!function(n,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?module.exports=e():n.Binder=e()}(this,function(){"use strict";function Binder(template,bindings,bindingsScope,inplaceMode,options){function bindingFactory(n,e){if("object"!=typeof e){var t=n.trim(),i=!1;"!"===t.substr(0,1)&&(t=t.substr(1).trim(),i=!0,inplace&&compileWarnings&&console.warn("Binder constructor: Once only binding selector '!"+t+"' ignored for in-place binders")),">"===t.substr(0,1)&&(t=":scope "+t);var r,o,s=createDataGetter(e,t);if(-1!==t.indexOf("@")){var c=t.split("@");if(2!==c.length)throw new TypeError("Binder constructor: Binding selector '"+t+"' contains multiple attribute/event tokens!");r=getActualNode(t=stripEndChildSelector(c[0]));var a=c[1].trim(),u=a.split(".");if(1===u.length)o=createAttributeSetBinding(r,s,t,a);else{if(2!==u.length)throw new TypeError("Binder constructor: Binding selector '"+t+"@"+a+"' contains multiple '.' sub-instructions!");var d=u[1].trim();switch(a=u[0].trim()){case"property":case"pty":o=createPropertyBinding(r,s,t,d);break;case"class":switch(createResetFunction(r,t,a,i),d){case"add":o=createClassAddBinding(r,s,t);break;case"remove":o=createClassRemoveBinding(r,s,t);break;default:throw new TypeError("Binder constructor: Binding selector '"+t+"@"+a+"."+d+"' is invalid - @class attribute can only have sub-instructions of '.add' or '.remove'!")}break;case"dataset":o=createDatasetBinding(r,s,t,d);break;case"style":createResetFunction(r,t,a,i),o=createStyleBinding(r,s,t,d);break;case"event":if("function"!=typeof e)throw TypeError("Binder constructor: Event binding instruction for selector '"+t+"@"+a+"."+d+"' must be a function!");if("bound"===d){if(afterBindEvent)throw TypeError("Binder constructor: Only one 'bound' event can be specified!");afterBindEvent=s}else eventBindings.push({eventName:d,cssSelector:t,eventFunction:s});break;default:if(createResetFunction(r,t,a,i),"remove"!==d)throw new TypeError("Binder constructor: Binding selector '"+t+"@"+a+"."+d+"' is invalid - only @class, @event, @dataset and @style attributes can have sub-instructions!");"function"!=typeof e&&compileWarnings&&console.warn("Binder constructor: Attribute remove '"+t+"' - usually expects function as binding instruction"),o=createRemoveAttributeBinding(r,s,t,a)}}}else if("#append"===t.substr(0-"#append".length)){if("function"!=typeof e)throw new TypeError("Binder constructor: Binding instruction for selector '"+t+" #append' must be a function!");o=createAppendNodesBinding(r=getActualNode(t=stripEndChildSelector(stripEndToken(t,"#append"))),s,t)}else o="#innerHTML"===t.substr(0-"#innerHTML".length)?createInnerHtmlBinding(r=getActualNode(t=stripEndChildSelector(stripEndToken(t,"#innerHTML"))),s,t):createTextContentBinding(r=getActualNode(t=stripEndChildSelector("#textContent"===t.substr(0-"#textContent".length)?stripEndToken(t,"#textContent"):t)),s,t);o&&(o.nonCloneable?postClonePropertyBindings.push(o.bindingFunction):bindingFunctions.push(o.bindingFunction),o.rebindingFunction&&!i&&rebindingFunctions.push(o.rebindingFunction))}else for(var l in e)e.hasOwnProperty(l)&&("!"===l.substr(0,1)?bindingFactory(("!"===n.substr(0,1)?"":"!")+n+" "+l.substr(1),e[l]):bindingFactory(n+" "+l,e[l]))}function createPropertyBinding(n,e,t,i){return inplace?{bindingFunction:function(t){var r=e(t);void 0!==r&&(n[i]=r)},rebindingFunction:function(n,r){var o=e(n);if(void 0!==o){var s=t?r.querySelector(t):r;s&&(s[i]=o)}}}:{nonCloneable:!0,bindingFunction:function(n,r){var o=e(n);if(void 0!==o){var s=t?r.querySelector(t):r;s&&(s[i]=o)}},rebindingFunction:function(n,r){var o=e(n);if(void 0!==o){var s=t?r.querySelector(t):r;s&&(s[i]=o)}}}}function createAttributeSetBinding(n,e,t,i){return{bindingFunction:function(t){n.setAttribute(i,e(t))},rebindingFunction:function(n,r){var o=t?r.querySelector(t):r;o&&o.setAttribute(i,e(n))}}}function createClassAddBinding(n,e,t){return{bindingFunction:function(t){var i=e(t);"string"==typeof i?n.classList.add(i):i instanceof Array&&i.forEach(function(e){n.classList.add(e)})},rebindingFunction:function(n,i){var r=t?i.querySelector(t):i,o=e(n);"string"==typeof o?r.classList.add(o):o instanceof Array&&o.forEach(function(n){r.classList.add(n)})}}}function createClassRemoveBinding(n,e,t){return{bindingFunction:function(t){var i=e(t);"string"==typeof i?n.classList.remove(i):i instanceof Array&&i.forEach(function(e){n.classList.remove(e)})},rebindingFunction:function(n,i){var r=t?i.querySelector(t):i,o=e(n);"string"==typeof o?r.classList.remove(o):o instanceof Array&&o.forEach(function(n){r.classList.remove(n)})}}}function createDatasetBinding(n,e,t,i){return{bindingFunction:function(t){n.dataset[i]=e(t)},rebindingFunction:function(n,r){(t?r.querySelector(t):r).dataset[i]=e(n)}}}function createStyleBinding(n,e,t,i){return{bindingFunction:function(t){n.style[i]=e(t)},rebindingFunction:function(n,r){(t?r.querySelector(t):r).style[i]=e(n)}}}function createRemoveAttributeBinding(n,e,t,i){return{bindingFunction:function(t){e(t)&&n.removeAttribute(i)},rebindingFunction:function(n,r){var o=t?r.querySelector(t):r;if(e(n))o.removeAttribute(i);else{var s=t?resetNode.querySelector(t):resetNode;s&&r.setAttribute(i,s.getAttribute(i))}}}}function createAppendNodesBinding(n,e,t){return{bindingFunction:function(t){var i=e(t);if(n.innerHTML="",void 0!==i)if(Array.isArray(i))for(var r=0,o=i.length;r<o;r++)n.appendChild(i[r]);else n.appendChild(i)},rebindingFunction:function(n,i){var r=t?i.querySelector(t):i,o=e(n);if(r.innerHTML="",void 0!==o)if(Array.isArray(o))for(var s=0,c=o.length;s<c;s++)r.appendChild(o[s]);else r.appendChild(o)}}}function createInnerHtmlBinding(n,e,t){return{bindingFunction:function(t){var i=e(t);void 0!==i&&(n.innerHTML=null!==i?i:"")},rebindingFunction:function(n,i){var r=t?i.querySelector(t):i,o=e(n);void 0!==o&&(r.innerHTML=null!==o?o:"")}}}function createTextContentBinding(n,e,t){return{bindingFunction:function(t){var i=e(t);void 0!==i&&(n.textContent=null!==i?i:"")},rebindingFunction:function(n,i){var r=t?i.querySelector(t):i,o=e(n);void 0!==o&&(r.textContent=null!==o?o:"")}}}function getActualNode(n){var e;try{e=n?templateNode.querySelectorAll(n):[templateNode]}catch(e){throw new TypeError("Binder constructor: Binding selector '"+n+"' caused exception! ("+e+")")}if(e.length>1)throw new TypeError("Binder constructor: Binding selector '"+n+"' returns multiple nodes from template!");if(0===e.length)throw new TypeError("Binder constructor: Binding selector '"+n+"' does not locate node in template!");return e[0]}function stripEndToken(n,e){return n.substr(0,n.length-e.length).trim()}function stripEndChildSelector(n){var e=n.trim();return(">"===e.substr(e.length-1)?e.substr(0,e.length-1):e).trim()}function createDataGetter(n,e){var t;if("function"==typeof n)t=n.bind(functionScope);else{if("string"!=typeof n)throw new TypeError("Binder constructor: Binding instruction for selector '"+e+"' must be a string or function!");t=templatedStringFunctionBuilder(n)}return t}function templatedStringFunctionBuilder(instruction){function buildCatch(n,e){var t=["catch(e){"];return bindWarnings&&t.push("console.warn(\"Binding instruction expression '",n,"' failed to retrieve value from \",",e,'," actual exception: ",e);'),t.push('return "";}'),t.join("")}var curliesRegex=/{{\s*([^}]+)\s*}}/g,result;if(instruction.match(curliesRegex)){for(var concatBuilder=[],lastEnd=0,match;match=curliesRegex.exec(instruction);)match.index>lastEnd&&concatBuilder.push('"'+match.input.substring(lastEnd,match.index).replace(/"/g,'\\"')+'"'),"$"===match[1].substr(0,1)?concatBuilder.push("(function(){try{return "+match[1].substr(1)+";}"+buildCatch(match[1],"data")+"}).bind(this)()"):"this."===match[1].substr(0,"this.".length)?concatBuilder.push("(function(d,self){try{return self."+match[1].substr(5)+";}"+buildCatch(match[1],"self")+"})(data,this)"):concatBuilder.push("(function(d){try{return d"+dotNotation2SquareBrackets(match[1])+";}"+buildCatch(match[1],"d")+"})(data)"),lastEnd=match.index+match[0].length;lastEnd<instruction.length&&concatBuilder.push('"'+instruction.substr(lastEnd).replace(/"/g,'\\"')+'"'),result=eval("(function(data){return "+concatBuilder.join("+")+";})").bind(bindingsScope)}else result="$"===instruction.substr(0,1)?eval("(function(data){try{return "+instruction.substr(1)+";}"+buildCatch(instruction.substr(1),"data")+"})").bind(bindingsScope):"this."===instruction.substr(0,"this.".length)?eval("(function(data){try{return "+instruction+";}"+buildCatch(instruction,"this")+"})").bind(bindingsScope):eval("(function(data){try{return data"+dotNotation2SquareBrackets(instruction)+";}"+buildCatch(instruction,"data")+"})").bind(bindingsScope);return result}function dotNotation2SquareBrackets(n){if(-1!==n.indexOf(".")){for(var e=n.split("."),t=[],i=0,r=e.length;i<r;i++)t.push("['"+e[i]+"']");return t.join("")}return"['"+n+"']"}function createResetFunction(n,e,t,i){var r=e+"@"+t;if(!uniqueResetsMap.hasOwnProperty(r)){var o,s,c=e?resetNode.querySelector(e):resetNode;switch(t){case"class":o=function(){n.className=c.className},s=function(n){(e?n.querySelector(e):n).className=c.className};break;case"style":o=function(){n.style.cssText=c.style.cssText},s=function(n){(e?n.querySelector(e):n).style.cssText=c.style.cssText};break;default:o=function(){c.hasAttribute(t)?n.setAttribute(t,c.getAttribute(t)):n.removeAttribute(t)},s=function(n){var i=e?n.querySelector(e):n;c.hasAttribute(t)?i.hasAttribute(t,c.getAttribute(t)):i.removeAttribute(t)}}uniqueResetsMap[r]=!0,o&&(resetFunctions.push(o),s&&!i&&rebindingResetFunctions.push(s))}}function isElement(n){return"object"==typeof HTMLElement?n instanceof HTMLElement:n&&"object"==typeof n&&null!==n&&1===n.nodeType&&"string"==typeof n.nodeName}function addEventBinding(n,e){var t=n.cssSelector?e.querySelector(n.cssSelector):e;t?t.addEventListener(n.eventName,function(i){var r=e.$boundData;return n.eventFunction(i,e,t,r)}):bindWarnings&&console.warn("Event binding selector '"+n.cssSelector+"' - could not find node")}function addEventBindings(n){for(var e=0,t=eventBindings.length;e<t;e++)addEventBinding(eventBindings[e],n)}function performResets(){for(var n=0,e=resetFunctions.length;n<e;n++)resetFunctions[n]()}function performBindings(n){for(var e=0,t=bindingFunctions.length;e<t;e++)bindingFunctions[e](n)}function performPostClonePropertyBindings(n,e){for(var t=0,i=postClonePropertyBindings.length;t<i;t++)postClonePropertyBindings[t](n,e)}function performRebindingResets(n){for(var e=0,t=rebindingResetFunctions.length;e<t;e++)rebindingResetFunctions[e](n)}function performRebindings(n,e){for(var t=0,i=rebindingFunctions.length;t<i;t++)rebindingFunctions[t](n,e)}function performAfterBoundEventFiring(n,e){afterBindEvent&&afterBindEvent(document.createEvent("event"),e,e,n)}function performSetNodeBoundDataProperty(n,e){e.$boundData=n}function bind(n){performResets(),performBindings(n);var e=templateNode.cloneNode(!0);return performSetNodeBoundDataProperty(n,e),performPostClonePropertyBindings(n,e),addEventBindings(e),performAfterBoundEventFiring(n,e),e}function rebind(n,e){return performRebindingResets(e),performRebindings(n,e),performPostClonePropertyBindings(n,e),performSetNodeBoundDataProperty(n,e),performAfterBoundEventFiring(n,e),e}function inplaceBind(n){return inplaceRebind(n)}function inplaceRebind(n){var e=arguments.length>0?n:templateNode.$boundData;return performResets(),performBindings(e),performSetNodeBoundDataProperty(e,templateNode),performAfterBoundEventFiring(e,templateNode),templateNode}function getBoundData(n){return inplace?templateNode.$boundData:n.$boundData}var inplace="boolean"==typeof inplaceMode&&inplaceMode,functionScope=bindingsScope||bindings,bindWarnings="object"==typeof options&&("boolean"==typeof options.bindWarnings&&options.bindWarnings),compileWarnings="object"==typeof options&&("boolean"==typeof options.compileWarnings&&options.compileWarnings),resetNode,templateNode;if(inplace){if(!isElement(template))throw new TypeError("Binder constructor: Argument 'template' must be an existing DOM HTMLElement!");templateNode=template,resetNode=template.cloneNode(!0)}else{if("string"==typeof template){var fragment=document.createElement("div");fragment.innerHTML=template,resetNode=fragment.firstElementChild}else{if(!isElement(template))throw new TypeError("Binder constructor: Argument 'template' must be a string or DOM HTMLElement!");resetNode="content"in template?document.importNode(template.content,!0).firstElementChild:template}templateNode=resetNode.cloneNode(!0)}var bindingFunctions=[],postClonePropertyBindings=[],rebindingFunctions=[],rebindingResetFunctions=[],eventBindings=[],resetFunctions=[],uniqueResetsMap={},afterBindEvent;for(var pty in bindings)bindings.hasOwnProperty(pty)&&bindingFactory(pty,bindings[pty]);return inplace&&addEventBindings(templateNode),{bind:inplace?inplaceBind:bind,rebind:inplace?inplaceRebind:rebind,getBoundData:getBoundData,isInplace:inplace}}return Binder});